<!doctype html>
<html lang="en" class="no-js">
    <head>
        <meta charset="UTF-8"/>
        <title>Trynkit: MicroPython</title>

        {% load static %}
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="{% static "css/main.css" %}" />
        <script src="/static/js/loadFile.js" type="text/javascript"></script>
        <script src="/static/js/save.js" type="text/javascript"></script>
        <script src="/static/js/codemirror.js" type="text/javascript"></script>
        <script src="/static/js/python.js" type="text/javascript"></script>
        <script src="/static/js/matchbrackets.js" type="text/javascript"></script>
        <script src="/static/js/closebrackets.js" type="text/javascript"></script>
        <script src="/static/js/bluetooth.js" type="text/javascript"></script>
        <script src="/static/js/lint.js" type="text/javascript"></script>
        <script src="/static/js/python-lint.js" type="text/javascript"></script>
        <link rel="stylesheet" type="text/css" href="/static/css/codemirror.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/ambiance.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/darcula.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/material.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/elegant.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/rubyblue.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/lint.css"/>



    </head>
    <div id="tabs">
    <script>
        var tabCount = 1;
        var currentTab = 'tab0';
    </script>
        <p></p>
        <button id="tab0" style="margin-left: 102px; margin-right: 0px" onclick='switchTab0()'>*.py</button>
        <button id="newTabBtn" onclick="newTab()">+</button>
        <script>
            function newTab() {
                var t = document.createElement('button');
                t.setAttribute('id', 'tab' + tabCount);
                document.getElementById('tabs').insertBefore(t, document.getElementById('newTabBtn'));
                t.innerText = 'Tab' + tabCount; //TODO set the name of the innertext to the file name for other user story
                tabCount++;
                sessionStorage.setItem(t.id, "");
				t.style.backgroundColor = '#50B6E2';
				var prevTab = document.getElementById('tab0');
				prevTab.style.backgroundColor = '#D3D3D3';
				for (i = 1; i < tabCount - 1; i++) {
					prevTab = document.getElementById('tab' + i);
					prevTab.style.backgroundColor = '#D3D3D3';
				}
                t.onclick = function() {
                    sessionStorage.setItem(currentTab, editor.getValue());
                    currentTab = t.id;
                    editor.setValue(sessionStorage.getItem(currentTab.toString()));
					var iTab = document.getElementById('tab0');
					for (i = 0; i < tabCount; i++) {
						iTab = document.getElementById('tab' + i);
						iTab.style.backgroundColor = '#D3D3D3';
					}
					t.style.backgroundColor = '#50B6E2';
                };
            }function newTab1(id) {
                var t = document.createElement('button');
                t.setAttribute('id', 'tab' + tabCount);
                document.getElementById('tabs').insertBefore(t, document.getElementById('newTabBtn'));
                t.innerText = id; //TODO set the name of the innertext to the file name for other user story
                tabCount++;
                sessionStorage.setItem(t.id, "");
                t.onclick = function() {
                    sessionStorage.setItem(currentTab, editor.getValue());
                    currentTab = t.id;
                    editor.setValue(sessionStorage.getItem(currentTab.toString()));
                };
            }
            function switchTab0() {
                sessionStorage.setItem(currentTab, editor.getValue());
                editor.setValue(sessionStorage.getItem('tab0'));
                currentTab = 'tab0';
				var iTab = document.getElementById('tab0');
				for (i = 0; i < tabCount; i++) {
					iTab = document.getElementById('tab' + i);
					iTab.style.backgroundColor = '#D3D3D3';
				}
				iTab = document.getElementById('tab0');
				iTab.style.backgroundColor = '#50B6E2';
            }


        </script>
    </div>
    <body>
        <div id="menu">
            <p>Menu</p>
            <button onclick="newFile()"><input type="image" id ="newFileBtn" src="/static/images/newFile.png" width="50" height="50"></button>
            <p></p>
            <button onclick="newProject()"><input type="image" id ="newProjectBtn" src="/static/images/newProject.png" width="50" height="50"></button>
            <p></p>
            <button onclick=saveEditorContents()><input type="image" id ="saveFileBtn" src="/static/images/savefile.png" width="50" height="50"></button>
            <p></p>
            <button id="loadFileBtn">
                <img src="/static/images/Load.png" width="50" height="50">
            </button>
            <span id="spnFilePath"></span>
            <input type="file" id="file" style="display: none" />
            <script type="text/javascript">
                window.onload = loadFile();
            </script>
            <p></p>
            <button onClick="bluetooth()"><input type="image" id ="devicesBtn" src="/static/images/Device.png" width="50" height="50"></button>
            <p></p>
            <button data-toggle="modal" data-target="#settingsModal"><input type="image" id ="settingsBtn" src="/static/images/Settings.png" width="50" height="50"></button>
             <p></p>
            <button onClick="consoleHide()"><input type ="image" id ="consoleBtn" src="/static/images/serial.png" width="50" height="50"></button>
            <p></p>
            <button><input type ="image" id="debuggerBtn" src="/static/images/tempBug.png" width="50" height="50"></button>
        <script>
        function consoleHide(){
            var x = document.getElementById('console');
            if (x.style.display ==="none"){
                x.style.display = "block";
            }else{
                x.style.display = "none";
            }
        }
        </script>
        </div>


        <div id="editor" contenteditable="true" name="empty"><textarea id="code-mirror"></textarea></div> <!-- we must not have any space between the div and close div-->
        <div id="console" contenteditable="true" name="empty" style="display:none">Serial Console</div>
        <div id="devices" name="empty" style="display:none"></div>


                <!-- Settings Modal -->
              <div class="modal fade" id="settingsModal" role="dialog" style="display:none">
                <div class="modal-dialog">
                  <!-- Modal content-->
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal">&times;</button>
                      <h4 class="modal-title">Settings</h4>
                    </div>
                    <div class="modal-body">
                      <p>Select theme for the editor</p>
                      <div class="dropdown">
                            <p>Select a theme: <select onchange="selectTheme()" id=select>
                                <option selected>default</option>
                                <option>ambiance</option>
                                <option>darcula</option>
                                <option>elegant</option>
                                <option>material</option>
                                <option>rubyblue</option>
                            </select></p>
                      </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                     </div>

                  </div>
                </div>
              </div>
    </body>

    <script>

        function newProject() {
            var projectName = prompt("Creating a new project:", "NewProjectName.py");
            document.getElementById('code-mirror').setAttribute('name', projectName);
            //create tab button with corresponding project name
            newTab1(projectName);
        }

        function check_syntax(code, result_cb)
        {
            var error_list = [{
                    line_no: 1,
                    column_no_start: 14,
                    column_no_stop: 17,
                    fragment: "def doesNothing:\n",
                    message: "invalid syntax",
                    severity: "error"
                }, {
                    line_no: 4,
                    column_no_start: 1,
                    column_no_stop: 3,
                    fragment: "a__ = 5\n",
                    message: "convention violation",
                    severity: "warning"
                }]

            result_cb(error_list);
           
        }

        //this is for the code editing
       var editor = CodeMirror.fromTextArea(document.getElementById("code-mirror"), {
       lineNumbers: true,
    mode: "python",
    gutters: ["CodeMirror-lint-markers"],
    //lint: python_validator,
   // async: true,
    lint: {
        "getAnnotations": python_validator,
        "async": true,
        "check_cb": check_syntax
    }
        });

        /**
         * This function is used to change the theme of the editor
         * When an option is selected in the settings dropdown menu
         * it changes the theme by what choice is selected.
         * @type {HTMLElement}
         */
        var input = document.getElementById("select");
        function selectTheme() {
            var theme = input.options[input.selectedIndex].textContent;
            editor.setOption("theme", theme);
            location.hash = "#" + theme;
          }
          var choice = (location.hash && location.hash.slice(1)) ||
                       (document.location.search &&
                        decodeURIComponent(document.location.search.slice(1)));
          if (choice) {
            input.value = choice;
            editor.setOption("theme", choice);
          }
          CodeMirror.on(window, "hashchange", function() {
            var theme = location.hash.slice(1);
            if (theme) { input.value = theme; selectTheme(); }
          });

    </script>
</html>

