<!doctype html>
<html lang="en" class="no-js">
    <head>
        <meta charset="UTF-8"/>
        <title>Trynkit: MicroPython</title>

        {% load static %}
         <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="{% static "css/main.css" %}" />

        <script src="/static/js/loadFile.js" type="text/javascript"></script>
        <script src="/static/js/save.js" type="text/javascript"></script>
        <script src="/static/js/codemirror.js" type="text/javascript"></script>
        <script src="/static/js/python.js" type="text/javascript"></script>
        <script src="/static/js/bluetooth.js" type="text/javascript"></script>
        <link rel="stylesheet" type="text/css" href="/static/css/codemirror.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/ambiance.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/darcula.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/material.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/elegant.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/rubyblue.css"/>
    </head>

    </div>
    <body>
        <div id="menu">
            <p></p>
            <button onclick="newFile()" id="nfBtn"><img type="image/svg+xml" id ="newFileBtn" src="/static/images/file-regular.svg" width="50" height="50"><figcaption> New File </figcaption></button>
            <p></p>
            <button onclick="newProject()" id="npBtn"><img type="image/svg+xml" id ="newProjectBtn" src="/static/images/folder-regular.svg" width="50" height="50"><figcaption> New Project </figcaption></button>
            <p></p>
            <button onclick="saveTabPrompt(currentTab)" id="sBtn" ><img type="image/svg+xml" id ="saveFileBtn" src="/static/images/save-regular.svg" width="50" height="50"><figcaption> Save File </figcaption></button>
            <p></p>
            <button id="loadFileBtn">
                <img type="image/svg+xml" src="/static/images/cloud-upload-alt-solid.svg" width="50" height="50"><figcaption> Load File </figcaption>

            </button>
            <span id="spnFilePath"></span>
            <input type="file" id="file" style="display: none" />
            <script type="text/javascript">
                window.onload = loadFile();
            </script>
            <p></p>

            <button onClick="bluetooth()" id="bBtn"><img type="image/svg+xml" id ="devicesBtn" src="/static/images/bluetooth-b-brands.svg" width="50" height="50"><figcaption> Bluetooth </figcaption></button>
            <p></p>
            <button data-toggle="modal" data-target="#settingsModal" id="settingsBtn"><img type="image/svg+xml" id ="settingsBtn" src="/static/images/cogs-solid.svg" width="50" height="50"><figcaption> Settings </figcaption></button>
             <p></p>
            <button onClick="consoleHide()" id="serialBtn"><img type="image/svg+xml"  src="/static/images/plug-solid.svg" width="50" height="50"><figcaption> Console </figcaption></button>
            <p></p>
            <button onclick="debugToggle()" id="debugBtn"><img type ="image/svg+xml" id="debuggerBtn" src="/static/images/bug-solid.svg" width="50" height="50"><figcaption> Debug </figcaption></button>
            <p></p>
            <button data-toggle="modal" data-target="#loginModal" id="loginBtn"><img type="image/svg+xml" id ="loginBtn" src="/static/images/login-regular.svg" width="50" height="50"><figcaption> Login </figcaption></button>
            <p></p>
            <button data-toggle="modal" data-target="#signUpModal" id="signBtn"><img type="image/svg+xml" id ="signBtn" src="/static/images/signup.svg" width="50" height="50"><figcaption> Sign Up </figcaption></button>

        </div>
	<!-- this is the context menu -->
        <!-- note the string to=0 where the 0 is the digit to be replaced -->
        <div id="div-context-menu" class="cls-context-menu">
		<ul>
                    <li><a href="javascript:void(0)" class="rename-tab">Rename Tab </a></li>
                </ul>
        </div>
        <div class="container">
            <ul class="nav nav-tabs" role="tablist">
		    <li class="active"><a href="#tab_01" id="tab01" data-toggle="tab">main.py</a><span>x</span>
                </li>
                <li><a href="javascript:void(0)" class="add-tab">+ New File</a>
                </li> 
            </ul>
            <ul class="nav close-tabs">
                <li><a href="javascript:void(0)" class="remove-tabs">- Close All Tabs</a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="tab_01"><textarea id="code"> </textarea></div>
            </div>
        </div>

       
		<div id="debugger" contenteditable="false" name="empty" style="display:none"><input type="text" id="dText" value="Debugger output here." readonly></div>
        <div id="console" contenteditable="true" name="empty" style="display:none">Serial Console</div>
        <div id="devices" name="empty" style="display:none"></div>



                <!-- Settings Modal -->
              <div class="modal fade" id="settingsModal" role="dialog" style="display:none">
                <div class="modal-dialog">
                  <!-- Modal content-->
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal">&times;</button>
                      <h4 class="modal-title">Settings</h4>
                    </div>
                    <div class="modal-body">
                      <p>Select theme for the editor</p>
                      <div class="dropdown">
                            <p>Select a theme: <select onchange="selectTheme()" id=select>
                                <option selected>default</option>
                                <option>ambiance</option>
                                <option>darcula</option>
                                <option>elegant</option>
                                <option>material</option>
                                <option>rubyblue</option>
                            </select></p>
                      </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                     </div>

                  </div>
                </div>
              </div>


     <!-- Create/ load Project modal -->
              <div class="modal fade" id="onloadModal" role="dialog" style="display:none">
                <div class="modal-dialog">
                  <!-- Modal content-->
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal">&times;</button>
                      <h4 class="modal-title">Create or Load Project</h4>
                    </div>
                    <div class="modal-body">
                      <p>Choose to either create a new project or load an existing project</p>
                      <div class="dropdown">
                           <button id="cBtn" data-dismiss="modal" onclick="newProject()">Create Project</button>
                          <button id="lBtn" data-dismiss="modal">Load Project</button>
                           <span id="spnFilePath1"></span>
            <input type="file" id="file1" style="display: none" />
            <script type="text/javascript">
                window.onload = loadProject();
            </script>
               </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                     </div>
                  </div>
                </div>
              </div>


                <!-- login Modal -->
                <div class="modal fade" id="loginModal" role="dialog" style="display:none">
                        <div class="modal-dialog">
                          <!-- Modal content-->
                          <div class="modal-content">
                            <div class="modal-header">
                              <button type="button" class="close" data-dismiss="modal">&times;</button>
                              <h4 class="modal-title">Login</h4>
                            </div>
                            <div class="modal-body">
                                <p>Please enter login credentials</p>
                                <div class="container">
                                    <label for="UserName"><b>Username</b></label>
                                    <input type="username" placeholder="Enter Username" name="userName" required>
                                    <p></p>          
                                    <label for="Password"><b>Password</b></label>
                                    <input type="password" placeholder="Enter Password" name="password" required>
                                    <p></p>                   
                                    <label>
                                        <input type="checkbox" checked="checked" name="remember"> Remember me
                                    </label>
                                    <p></p>
                                    <button type="submit">Login</button>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" onclick="document.getElementById('login').style.display='none'" class="cancelbtn">Cancel</button>
                                    <span class="psw">Forgot <a href="#">password?</a></span>
                                </div>
                             </div>
                          </div>
                        </div>
                      </div>

            <!-- Sign Up Modal -->
            <div class="modal fade" id="signUpModal" role="dialog" style="display:none">
                <div class="modal-dialog">
                  <!-- Modal content-->
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal">&times;</button>
                      <h4 class="modal-title">Sign Up</h4>
                    </div>
                    <div class="modal-body">
                        <p>Welcome to the Trynkit Community</p>
                        <div class="container">
                            <label for="UserName"><b>Username</b></label>
                            <input type="username" placeholder="Enter Username" name="userName" required>
                            <p></p>          
                            <label for="Password"><b>Password</b></label>
                            <input type="password" placeholder="Enter Password" name="password" required>
                            <p></p>      
                            <label for="PasswordCheck"><b>Re-enter Password</b></label>
                            <input type="password" placeholder="Re-enter Password" name="passwordCheck" required>
                            <p></p>
                            <button type="submit" onclick="signUp()">Sign Up</button>
                        </div>
                     </div>
                  </div>
                </div>
              </div>
    </body>

    <script>
        document.getElementById('code').setAttribute('name', 'main.py');
        /**
         * signUp()
         * This function verifies the username is unique, verifies that 
         * the password matches the re-entered password and adds the
         * new user credentials.
         */
        function signUp(){
            var SignUpVerification = confirm("Sign Up Complete!");
        }
        /**
         * newProject()
         * This function is to create a new project.
         * It is called from the newPrjoect button or in the popup modal
         * at the load of the page.
         */
        function newProject() {
            //TODO this needs changed to reflect the new project code right now just creates a file
            var projectName = prompt("Creating a new project:", "NewProjectName.py");
            document.getElementById('code').setAttribute('name', projectName);
            newFile();
            //NOTE: upon saving the newFile is intented to be saved within a folder titled with the projectName variable
        }

        /**
         * newFile()
         * called by the create new file button
         * invokes the add-tab button click to create a new tab
         */
         function newFile() {
            $(".add-tab").click();
        }

        /**
         * debugToggle()
         * This function shows the debug console or if the console is shown
         * then hide the console.
         */
		function debugToggle() {
			var debugDiv = document.getElementById('debugger');
			debugDiv.style.display = debugDiv.style.display == "none" ? "block" : "none";
		}

		/**
         * consoleHide()
         * This function shows or hides the serial console based on its current state.
         */
        function consoleHide(){
            var x = document.getElementById('console');
            if (x.style.display ==="none"){
                x.style.display = "block";
            }else{
                x.style.display = "none";
            }
        }

		/**
         * Code Mirror
         * This initializes the code mirror editor.
         * It is set in the "code" text area.
         */
        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        mode: {name: "python",
               version: 3,
               theme: "default",
               singleLineStringErrors: false},
        lineNumbers: true,
        indentUnit: 4,
        matchBrackets: true,
        autofocus:true
        });

        /**
         * selectTheme()
         * This function is used to change the theme of the editor
         * When an option is selected in the settings dropdown menu
         * it changes the theme by what choice is selected.
         * @type {HTMLElement}
         */
        var input = document.getElementById("select");
        function selectTheme() {
            var theme = input.options[input.selectedIndex].textContent;
            editor.setOption("theme", theme);
            location.hash = "#" + theme;
          }
          var choice = (location.hash && location.hash.slice(1)) ||
                       (document.location.search &&
                        decodeURIComponent(document.location.search.slice(1)));
          if (choice) {
            input.value = choice;
            editor.setOption("theme", choice);
          }
          CodeMirror.on(window, "hashchange", function() {
            var theme = location.hash.slice(1);
            if (theme) { input.value = theme; selectTheme(); }
          });

        /**
         * This function is for the startup model to show only when the page loads
         * It also checks to see if there is any data in local storage to be loaded,
         * if it is there popluate the masterlist variable with file names and then
         * call populate list function to add tabs accordingly.
         */
        var masterList = ["main.py"]; /* array variable to store the tab names */
        $(window).on('load',function(){
            $('#onloadModal').modal('show');
            try{
                masterList = localStorage.getItem("tabList").toString();
                masterList = masterList.split(",");
                populateTabs();
            }catch(error){
                console.error(error);
            }
            
        });

        /**
         * populateTabs()
         * This function populates the tabs with the tab names
         * with the list of filenames that was loaded from local storage.
         */
        function populateTabs(){
            for(i =1; i< masterList.length; i++){
						  $(".add-tab").closest('li').before('<li><a href="#tab_' + i + '">"'+ masterList[i].toString()+'"</a> <span> x </span></li>');
            }
        }

        /**
         * This is for the bootstrap toggeable tabs
         * has the ability add new tabs and close tabs
         */
        var currentTab = "main.py";  /* used to determine the previous tab */
        var tabList;

        /**
         * This function handles all of the logic when clicking on a tab
         * it also saves the previous tabs contents into local storage.
         */
         $(".nav-tabs").on("click", "a", function (e) {
            e.preventDefault();
             if (!$(this).hasClass('add-tab')) {
                 localStorage.setItem(currentTab, editor.getValue());
                 $(this).tab('show');
                 currentTab = this.innerText;
                 try {
                     editor.setValue(localStorage.getItem(currentTab).toString());
                 }catch(e){
                     console.error(e);
                 }
                }
            })
            .on("click", "span", function () { //this is to handle the remove button
                    saveTabPrompt(currentTab);
                    //TODO remove the code in the editor 
                    $(this).parent().remove(); //this removes the tab
                   
        });
            /**
             * This function handles the logic for when you add a tab
             * by clicking the add tab button. It prompts user for a filename,
             * adds new tab with the filename. Saves it into local storage in masterlist variable,
             * and sets the tab to be the open tab.
             */
            $('.add-tab').click(function (e) {
                localStorage.setItem(currentTab, editor.getValue());
                var projectName = prompt("Creating a new file:", "NewProjectName.py");
                if(projectName){
                    e.preventDefault();
                    var id = $(".nav-tabs").children().length; 
                    var tabId = 'tab_' + id;
		    $(this).closest('li').before('<li class="active"><a href="#tab_' + id + '">'+ projectName+'</a> <span> x </span></li>');
		    currentTab = projectName; 
                    masterList.push(projectName); 
                    localStorage.setItem("tabList", masterList); /* add tab to the tab list */
                    editor.setValue("");
                    $('.nav-tabs li:nth-child(' + id + ') a').click();
                }else{
                    //Don't do anything
                }
        });
        /**
         * This function handles all of the logic when close all tabs button is clicked
         *
         */
        $('.remove-tabs').click(function(e) {
               if (confirm("Would you like to close and save all tabs?")) {
                    var navTabsLength = $(".nav-tabs").children().length;
                    var k = 0;
                    if (navTabsLength > 1 ) {
                        for (var i=0; i < navTabsLength +1; i++){
                            if ($(".nav-tabs").children().eq(i).hasClass('active')) {
                                downloadEditorContents(masterList[k]);
                                $(".nav-tabs").children().eq(i).remove();
                                i--;
                                k++;
                                tabList = null;
                            }
                        }
                    }
                }
            });
	    $('.rename-tab').click(function(e) {
	    var newTabName = prompt("Enter a new name for the current tab: ", ".py");
	    var selectedTab = sessionStorage.getItem('selectedTab');
            document.querySelectorAll("a[href=selectedTab]").innerHTML = newTabName;
	});
	$(document).click(function(event) {
		var text = $(event.target).text();
    	});
	
	//
	var rgtClickContextMenu = document.getElementById('div-context-menu');
	
	document.onclick = function(e){
	rgtClickContextMenu.style.display = 'none';
	}
	
	//**
        /* present the right click context menu ONLY for the elements having the right class
        /* by replacing the 0 or any digit after the "to-" string with the element id , which
        /* triggered the event
        /*/
	
	document.oncontextmenu = function(e){
	var elmnt = e.target	
	if ( elmnt.toString().includes("tab")) {
		e.preventDefault();
		//var eid = elmnt.id;
		sessionStorage.setItem("selectedTab", elmnt.toString().replace("https://127.0.0.1:8000/", " "));

                rgtClickContextMenu.style.left = e.pageX + 'px';
                rgtClickContextMenu.style.top = e.pageY + 'px';
                rgtClickContextMenu.style.display = 'block';
                //var toRepl = "to=" + eid.toString();
                //rgtClickContextMenu.innerHTML = rgtClickContextMenu.innerHTML.replace(/to=\d+/g,toRepl);
		}
	}
    </script>

</html>

