<!doctype html>
<html lang="en" class="no-js">
    <head>
        <meta charset="UTF-8"/>
        <title>Trynkit: MicroPython</title>

        {% load static %}
         <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="{% static "css/main.css" %}" />

        <script src="/static/js/loadFile.js" type="text/javascript"></script>
        <script src="/static/js/save.js" type="text/javascript"></script>
        <script src="/static/js/codemirror.js" type="text/javascript"></script>
        <script src="/static/js/python.js" type="text/javascript"></script>
        <script src="/static/js/bluetooth.js" type="text/javascript"></script>
        <link rel="stylesheet" type="text/css" href="/static/css/codemirror.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/ambiance.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/darcula.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/material.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/elegant.css"/>
        <link rel="stylesheet" type="text/css" href="/static/css/rubyblue.css"/>



    </head>
    
    <script>
        var tabCount = 1;
        var currentTab = 'tab0'; 
       


         /*   function loadTab() {
                var t = document.createElement('button');
                t.setAttribute('id', 'tab' + tabCount);
                document.getElementById('tabs').insertBefore(t, document.getElementById('newTabBtn'));
                t.innerText = 'Tab' + tabCount;
                tabCount++;
                t.style.backgroundColor = '#50B6E2';
                var prevTab = document.getElementById('tab0');
                prevTab.style.backgroundColor = '#D3D3D3';
                for (i = 1; i < tabCount - 1; i++) {
                    prevTab = document.getElementById('tab' + i);
                    prevTab.style.backgroundColor = '#D3D3D3';
                }
                t.onclick = function() { //TODO refactor this function below because newTab also uses it
                    localStorage.setItem(currentTab, editor.getValue());
                    currentTab = t.id;
                    editor.setValue(localStorage.getItem(currentTab.toString()));
                    var iTab = document.getElementById('tab0');
                    for (i = 0; i < tabCount; i++) {
                        iTab = document.getElementById('tab' + i);
                        iTab.style.backgroundColor = "#D3D3D3";
                        iTab.disabled = false;
                    }
                    t.style.backgroundColor = "#50B6E2";
                    t.disabled = true;
                };
            }
            function newTab() {
                var t = document.createElement('button');
                t.setAttribute('id', "tab" + tabCount);
                document.getElementById('tabs').insertBefore(t, document.getElementById('newTabBtn'));
                t.innerText = "Tab" + tabCount; //TODO set the name of the innertext to the file name for other user story
                tabCount++;
                localStorage.setItem(t.id, "");
				t.style.backgroundColor = "#50B6E2";
				var prevTab = document.getElementById('tab0');
				prevTab.style.backgroundColor = "#D3D3D3";
				for (i = 1; i < tabCount - 1; i++) {
					prevTab = document.getElementById('tab' + i);
					prevTab.style.backgroundColor = "#D3D3D3";
				}
                t.onclick = function() {
                    localStorage.setItem(currentTab, editor.getValue());
                    currentTab = t.id;
                    editor.setValue(localStorage.getItem(currentTab.toString()));
					var iTab = document.getElementById('tab0');
					for (i = 0; i < tabCount; i++) {
						iTab = document.getElementById('tab' + i);
						iTab.style.backgroundColor = '#D3D3D3';
                        iTab.disabled = false;
					}
					t.style.backgroundColor = '#50B6E2';
                    t.disabled = true;
                };
            }
            function newTab1(id) {
                var t = document.createElement('button');
                t.setAttribute('id', "tab" + tabCount);
                document.getElementById('tabs').insertBefore(t, document.getElementById('newTabBtn'));
                t.innerText = id; //TODO set the name of the innertext to the file name for other user story
                tabCount++;
                localStorage.setItem(t.id, "");
                t.style.backgroundColor = "#50B6E2";
                var prevTab = document.getElementById('tab0');
                prevTab.style.backgroundColor = "#D3D3D3";
                for (i = 1; i < tabCount -1; i++) {
                    prevTab = document.getElementById('tab' + i);
                    prevTab.style.backgroundColor = "#D3D3D3";
                }
                t.onclick = function() {
                    localStorage.setItem(currentTab, editor.getValue());
                    currentTab = t.id;
                    editor.setValue(localStorage.getItem(currentTab.toString()));
                    var iTab = document.getElementById('tab0');
                    for (i = 0; i < tabCount; i++) {
                        iTab = document.getElementById('tab' + i);
                        iTab.style.backgroundColor = "#D3D3D3";
                        iTab.disabled = false
                    }
                    t.style.backgroundColor = "#50B6E2";
                    t.disabled = true;
                };
            }
            function switchTab0() {
                localStorage.setItem(currentTab, editor.getValue());
                editor.setValue(localStorage.getItem('tab0'));
                currentTab = "tab0";
				var iTab = document.getElementById('tab0');
				for (i = 0; i < tabCount; i++) {
					iTab = document.getElementById('tab' + i);
					iTab.style.backgroundColor = '#D3D3D3';
                    iTab.disabled = false;
				}
				iTab = document.getElementById('tab0');
                iTab.disabled = true;
				iTab.style.backgroundColor = '#50B6E2';
            }
            document.onreadystatechange = function() {
                if (localStorage.length == 0) {
                    document.getElementById('tab0').disabled = true;
                } else {
                    currentTab = "tab" + (localStorage.length - 1);
                    editor.setValue(localStorage.getItem(currentTab).toString());
                    for (i = 1; i < localStorage.length - 1; i++) {
                        loadTab();
                    }
                }
            } */
        </script>
    </div>
    <body>
        <div id="menu">
            <p>Menu</p>
            <button onclick="newFile()" id="nfBtn"><img type="image/svg+xml" id ="newFileBtn" src="/static/images/file-regular.svg" width="50" height="50"></button>
            <p></p>
            <button onclick="newProject()" id="npBtn"><img type="image/svg+xml" id ="newProjectBtn" src="/static/images/folder-regular.svg" width="50" height="50"></button>
            <p></p>
            <button onclick="saveEditorContents()" id="sBtn" ><img type="image/svg+xml" id ="saveFileBtn" src="/static/images/save-regular.svg" width="50" height="50"></button>
            <p></p>
            <button id="loadFileBtn">
                <img type="image/svg+xml" src="/static/images/cloud-upload-alt-solid.svg" width="50" height="50">

            </button>
            <span id="spnFilePath"></span>
            <input type="file" id="file" style="display: none" />
            <script type="text/javascript">
                window.onload = loadFile();
            </script>
            <p></p>

            <button onClick="bluetooth()" id="bBtn"><img type="image/svg+xml" id ="devicesBtn" src="/static/images/bluetooth-b-brands.svg" width="50" height="50"></button>
            <p></p>
            <button data-toggle="modal" data-target="#settingsModal" id="settingsBtn"><img type="image/svg+xml" id ="settingsBtn" src="/static/images/cogs-solid.svg" width="50" height="50"></button>
             <p></p>
            <button onClick="consoleHide()" id="serialBtn"><img type="image/svg+xml"  src="/static/images/plug-solid.svg" width="50" height="50"></button>
            <p></p>
            <button onclick="debugToggle()" id="debugBtn"><img type ="image/svg+xml" id="debuggerBtn" src="/static/images/bug-solid.svg" width="50" height="50"></button>
       
     <script>
        function consoleHide(){
            var x = document.getElementById('console');
            if (x.style.display ==="none"){
                x.style.display = "block";
            }else{
                x.style.display = "none";
            }
        }
        </script>
        </div>

        <div class="container">
            <ul class="nav nav-tabs" role="tablist">
                <li class="active"><a href="#tab_01" data-toggle="tab">*.py</a><span>x</span>
                </li>
                <li><a href="javascript:void(0)" class="add-tab">+ New File</a>
                </li> 
            </ul>
            <ul class="nav close-tabs">
                <li><a href="javascript:void(0)" class="remove-tabs">- Close All Tabs</a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="tab_01"><textarea id="code"></textarea></div>
                
            </div>
        </div>

       
		<div id="debugger" contenteditable="false" name="empty" style="display:none"><input type="text" id="dText" value="Debugger output here." readonly></div>
        <div id="console" contenteditable="true" name="empty" style="display:none">Serial Console</div>
        <div id="devices" name="empty" style="display:none"></div>



                <!-- Settings Modal -->
              <div class="modal fade" id="settingsModal" role="dialog" style="display:none">
                <div class="modal-dialog">
                  <!-- Modal content-->
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal">&times;</button>
                      <h4 class="modal-title">Settings</h4>
                    </div>
                    <div class="modal-body">
                      <p>Select theme for the editor</p>
                      <div class="dropdown">
                            <p>Select a theme: <select onchange="selectTheme()" id=select>
                                <option selected>default</option>
                                <option>ambiance</option>
                                <option>darcula</option>
                                <option>elegant</option>
                                <option>material</option>
                                <option>rubyblue</option>
                            </select></p>
                      </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                     </div>

                  </div>
                </div>
              </div>


     <!-- Create/ load Project modal -->
              <div class="modal fade" id="onloadModal" role="dialog" style="display:none">
                <div class="modal-dialog">
                  <!-- Modal content-->
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal">&times;</button>
                      <h4 class="modal-title">Create or Load Project</h4>
                    </div>
                    <div class="modal-body">
                      <p>Choose to either create a new project or load an existing project</p>
                      <div class="dropdown">
                           <button id="cBtn" data-dismiss="modal" onclick="newProject()">Create Project</button>
                          <button id="lBtn" data-dismiss="modal">Load Project</button>
                           <span id="spnFilePath1"></span>
            <input type="file" id="file1" style="display: none" />
            <script type="text/javascript">
                window.onload = loadProject();
            </script>
                       
               </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                     </div>

                  </div>
                </div>
              </div>
    </body>

    <script>
        document.getElementById('code').setAttribute('name', '.py');
        function newProject() {
            //TODO this needs changed to reflect the new project code right now just creates a file
            var projectName = prompt("Creating a new project:", "NewProjectName.py");
            document.getElementById('code').setAttribute('name', projectName);
            //create tab button with corresponding project name
            newTab1(projectName);
            switchTab0();
        }

        /**
         * newFile()
         * called by the create new file button
         * invokes the add-tab button click to create a new tab
         */
         function newFile() {
            $(".add-tab").click();
        }

		function debugToggle() {
			var debugDiv = document.getElementById('debugger');
			debugDiv.style.display = debugDiv.style.display == "none" ? "block" : "none";
		}

		/**
         * Code Mirror
         * This initializes the code mirror editor.
         * It is set in the "code" text area.
         */
        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        mode: {name: "python",
               version: 3,
               theme: "default",
               singleLineStringErrors: false},
        lineNumbers: true,
        indentUnit: 4,
        matchBrackets: true,
        autofocus:true
        });

        /**
         * selectTheme()
         * This function is used to change the theme of the editor
         * When an option is selected in the settings dropdown menu
         * it changes the theme by what choice is selected.
         * @type {HTMLElement}
         */
        var input = document.getElementById("select");
        function selectTheme() {
            var theme = input.options[input.selectedIndex].textContent;
            editor.setOption("theme", theme);
            location.hash = "#" + theme;
          }
          var choice = (location.hash && location.hash.slice(1)) ||
                       (document.location.search &&
                        decodeURIComponent(document.location.search.slice(1)));
          if (choice) {
            input.value = choice;
            editor.setOption("theme", choice);
          }
          CodeMirror.on(window, "hashchange", function() {
            var theme = location.hash.slice(1);
            if (theme) { input.value = theme; selectTheme(); }
          });

        /**
         * This function is for the startup modal to show only when the page loads
         */
        $(window).on('load',function(){
        $('#onloadModal').modal('show');
        });

        /**
         * This is for the bootstrap toggeable tabs
         * has the ability to add new tabs and close tabs
         */
         $(".nav-tabs").on("click", "a", function (e) {
            e.preventDefault();
             if (!$(this).hasClass('add-tab')) {
                $(this).tab('show');
                }
            })
            .on("click", "span", function () { //this is to handle the remove button
                    //todo prompt the user to save file
                    //TODO remove the code in the editor 
                    $(this).parent().remove(); //this removes the tab
                   
        });
	        
            //This function handles the logic when you click add tab
            $('.add-tab').click(function (e) {
                var projectName = prompt("Creating a new project:", "NewProjectName.py");
                e.preventDefault();
                var id = $(".nav-tabs").children().length; 
                var tabId = 'tab_' + id;
                $(this).closest('li').before('<li class="active"><a href="#tab_' + id + '">"'+ projectName+'"</a> <span> x </span></li>');
                $('.nav-tabs li:nth-child(' + id + ') a').click();
        });
	        //This function handles the logic when you click close all tabs
            $('.remove-tabs').click(function(e) {
               if (confirm("Would you like to close and save all tabs?")) {
                    var navTabsLength = $(".nav-tabs").children().length;
                    if (navTabsLength > 1 ) {
                        for (var i=0; i < navTabsLength +1; i++){
                            if ($(".nav-tabs").children().eq(i).hasClass('active')) {
                                $(".nav-tabs").children().eq(i).remove();
                                i--;
                            }
                        }
                    }
                }
            });
            
    </script>

</html>

